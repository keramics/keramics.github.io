<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Virtual Hard Disk (VHD) - Keramics data format specifications</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Keramics data format specifications</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="virtual-hard-disk-vhd-image-format"><a class="header" href="#virtual-hard-disk-vhd-image-format">Virtual Hard Disk (VHD) image format</a></h1>
<p>The Virtual Hard Disk (VHD) format is used by Microsoft vitualization products
as one of its image format. It is both used the store hard disk images and
snapshots.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>There are multiple types of VHD images, namely:</p>
<ul>
<li>Fixed-size VHD image</li>
<li>Dynamic-size (or sparse) VHD image</li>
<li>Differential (or differencing) VHD image</li>
</ul>
<h3 id="fixed-size-hard-disk-image"><a class="header" href="#fixed-size-hard-disk-image">Fixed-size hard disk image</a></h3>
<p>A fixed-size VHD image consists of:</p>
<ul>
<li>data</li>
<li>file footer</li>
</ul>
<blockquote>
<p>Note that a fixed-size VHD image is equivalent to a raw storage media image
with an additional footer.</p>
</blockquote>
<h3 id="dynamic-size-or-sparse-hard-disk-image"><a class="header" href="#dynamic-size-or-sparse-hard-disk-image">Dynamic-size (or sparse) hard disk image</a></h3>
<p>A dynamic-size (or sparse) VHD image consists of:</p>
<ul>
<li>copy of file footer</li>
<li>dynamic disk header</li>
<li>block allocation table</li>
<li>data in blocks</li>
<li>file footer</li>
</ul>
<h3 id="differential-hard-disk-image"><a class="header" href="#differential-hard-disk-image">Differential hard disk image</a></h3>
<p>A differential (or differencing) VHD image consists of:</p>
<ul>
<li>copy of file footer</li>
<li>dynamic disk header</li>
<li>block allocation table</li>
<li>data in blocks</li>
<li>file footer</li>
</ul>
<h3 id="characteristics"><a class="header" href="#characteristics">Characteristics</a></h3>
<div class="table-wrapper"><table><thead><th>Characteristics</th><th>Description</th></thead><tr><td>Byte order</td><td>big-endian</td></tr>
<tr><td>Date and time values</td><td>Number of seconds since January 1, 2000 00:00:00 UTC</td></tr>
<tr><td>Character strings</td><td>UCS-2 big-endian, which allows for unpaired Unicode surrogates such as "U+d800" and "U+dc00"</td></tr>
</table></div>
<p>The number of bytes per sector is 512.</p>
<h3 id="undo-disk-image"><a class="header" href="#undo-disk-image">Undo disk image</a></h3>
<p>Virtual PC has a feature to create "Undo Disks". This undo disk feature stores
a differential hard disk image in files named something similar like:</p>
<pre><code>VirtualPCUndo_&lt;name&gt;_0_0_hhmmssMMDDYYYY.vud
</code></pre>
<p>Where the date and time seems to be stored in UTC and &lt;name&gt; represents the
name of the parent image.</p>
<h2 id="file-footer"><a class="header" href="#file-footer">File footer</a></h2>
<p>The file footer is 512 bytes in size and consists of:</p>
<div class="table-wrapper"><table><thead><th>Offset</th><th>Size</th><th>Value</th><th>Description</th></thead><tr><td>0</td><td>8</td><td>"conectix"</td><td>Signature (also referred to as cookie)</td></tr>
<tr><td>8</td><td>4</td><td></td><td>Features</td></tr>
<tr><td>12</td><td>4</td><td>0x00010000</td><td>Format version, where the upper 16-bit are the major version and the lower 16-bit the minor version</td></tr>
<tr><td>16</td><td>8</td><td></td><td>Next offset, which contains the offset to the next (metadata) structure. The offset is relative from the start of the file. It should only be set in dynamic and differential disk images. In fixed disk images it should be set to 0xffffffffffffffff (-1).</td></tr>
<tr><td>24</td><td>4</td><td></td><td>Modification time, which contains the number of seconds since January 1, 2000 00:00:00 UTC</td></tr>
<tr><td>28</td><td>4</td><td></td><td>Creator application</td></tr>
<tr><td>32</td><td>4</td><td></td><td>Creator version, where the upper 16-bit are the major version and the lower 16-bit the minor version</td></tr>
<tr><td>36</td><td>4</td><td></td><td>Creator (host) operating system</td></tr>
<tr><td>40</td><td>8</td><td></td><td>Disk size, which contains the size of the disk in bytes</td></tr>
<tr><td>48</td><td>8</td><td></td><td>Data size, which contains the size of the data in bytes</td></tr>
<tr><td>56</td><td>4</td><td></td><td>Disk geometry</td></tr>
<tr><td>60</td><td>4</td><td></td><td>Disk type</td></tr>
<tr><td>64</td><td>4</td><td></td><td>Checksum</td></tr>
<tr><td>68</td><td>16</td><td></td><td>Identifier, which contains a big-endian UUID</td></tr>
<tr><td>84</td><td>1</td><td></td><td>Saved state, which contains a flag to indicate the image is in saved state.</td></tr>
<tr><td>85</td><td>427</td><td>0</td><td>Unknown (Reserved should contain 0-byte values)</td></tr>
</table></div>
<blockquote>
<p>Note that the checksum is a one's complement of the sum of all the bytes in
the file footer without the checksum field.</p>
</blockquote>
<h3 id="features"><a class="header" href="#features">Features</a></h3>
<div class="table-wrapper"><table><thead><th>Offset</th><th>Size</th><th>Value</th><th>Description</th></thead><tr><td>0.0</td><td>1 bit</td><td></td><td>Is temporary disk, which indicates that this disk is a candidate for deletion on shutdown</td></tr>
<tr><td>0.1</td><td>1 bit</td><td></td><td>Unknown (Reserved, must be set to 1)</td></tr>
<tr><td>0.2</td><td>30 bits</td><td></td><td>Unknown (Reserved, must be set to 0)</td></tr>
</table></div>
<p>A value of 0 represents no features are enabled.</p>
<h3 id="creator-application"><a class="header" href="#creator-application">Creator application</a></h3>
<div class="table-wrapper"><table><thead><th>Value</th><th>Identifier</th><th>Description</th></thead><tr><td>"d2v\x00"</td><td></td><td>Disk2vhd</td></tr>
<tr><td>"qemu"</td><td></td><td>Qemu</td></tr>
<tr><td>"vpc\x20"</td><td></td><td>Virtual PC</td></tr>
<tr><td>"vs\x20\x20"</td><td></td><td>Virtual Server</td></tr>
<tr><td>"win\x20"</td><td></td><td>Windows (Disk Management)</td></tr>
</table></div>
<h3 id="creator-host-operating-system"><a class="header" href="#creator-host-operating-system">Creator host operating system</a></h3>
<div class="table-wrapper"><table><thead><th>Value</th><th>Identifier</th><th>Description</th></thead><tr><td>"Mac\x20"</td><td></td><td>Macintosh</td></tr>
<tr><td>"Wi2k"</td><td></td><td>Windows</td></tr>
</table></div>
<h3 id="disk-geometry"><a class="header" href="#disk-geometry">Disk geometry</a></h3>
<p>The disk geometry is 4 bytes in size and consists of:</p>
<div class="table-wrapper"><table><thead><th>Offset</th><th>Size</th><th>Value</th><th>Description</th></thead><tr><td>0</td><td>2</td><td></td><td>Number of cylinders</td></tr>
<tr><td>2</td><td>1</td><td></td><td>Number of heads</td></tr>
<tr><td>3</td><td>1</td><td></td><td>Number of sectors per track (cylinder)</td></tr>
</table></div>
<h3 id="disk-type"><a class="header" href="#disk-type">Disk type</a></h3>
<div class="table-wrapper"><table><thead><th>Value</th><th>Identifier</th><th>Description</th></thead><tr><td>0</td><td></td><td>None</td></tr>
<tr><td>1</td><td></td><td>Unknown (Deprecated)</td></tr>
<tr><td>2</td><td></td><td>Fixed hard disk</td></tr>
<tr><td>3</td><td></td><td>Dynamic hard disk</td></tr>
<tr><td>4</td><td></td><td>Differential hard disk</td></tr>
<tr><td>5</td><td></td><td>Unknown (Deprecated)</td></tr>
<tr><td>6</td><td></td><td>Unknown (Deprecated)</td></tr>
</table></div>
<h2 id="dynamic-disk-header"><a class="header" href="#dynamic-disk-header">Dynamic disk header</a></h2>
<p>The dynamic disk header is 1024 bytes in size and consists of:</p>
<div class="table-wrapper"><table><thead><th>Offset</th><th>Size</th><th>Value</th><th>Description</th></thead><tr><td>0</td><td>8</td><td>"cxsparse"</td><td>Signature (Cookie)</td></tr>
<tr><td>8</td><td>8</td><td></td><td>Next offset, which contains the offset to the next (metadata) structure. The offset is relative from the start of the file. Currently this is unused and should be set to 0xffffffffffffffff (-1).</td></tr>
<tr><td>16</td><td>8</td><td></td><td>Block allocation table offset, whic contains the offset to the block allocation table structure. The offset is relative from the start of the file.</td></tr>
<tr><td>24</td><td>4</td><td>0x00010000</td><td>Format version, where the upper 16-bit are the major version and the lower 16-bit the minor version</td></tr>
<tr><td>28</td><td>4</td><td></td><td>Number of blocks, which contains the maximum number of block allocation table entries</td></tr>
<tr><td>32</td><td>4</td><td></td><td>Block size. The block size must be a power-of-two multitude of the sector size and does not include the size of the sector bitmap. The default block size is 4096 x 512-byte sectors (2 MB).</td></tr>
<tr><td>36</td><td>4</td><td></td><td>Checksum</td></tr>
<tr><td>40</td><td>16</td><td></td><td>Parent identifier, which contains a big-endian UUID that identifies the parent image. Only used by differential hard disk images.</td></tr>
<tr><td>56</td><td>4</td><td></td><td>Parent last modification time, which contains the number of seconds since January 1, 2000 00:00:00 UTC. Only used by differential hard disk images.</td></tr>
<tr><td>60</td><td>4</td><td>0</td><td>Unknown (Reserved should contain 0-byte values)</td></tr>
<tr><td>64</td><td>512</td><td></td><td>Parent name, which contains an UCS-2 big-endian string. Only used by differential hard disk images.</td></tr>
<tr><td>576</td><td>8 x 24 = 192</td><td></td><td>Array of parent locator entries. Only used by differential hard disk images.</td></tr>
<tr><td>768</td><td>256</td><td>0</td><td>Unknown (Reserved should contain 0-byte values)</td></tr>
</table></div>
<p>The maximum number of block allocation table entries should match the maximum
possible number of blocks in the disk.</p>
<blockquote>
<p>Note that the parent name can also contain a full path, e.g. in .avhd files.
The part segments are separated by the \ character.</p>
</blockquote>
<blockquote>
<p>Note that the checksum is a one's complement of the sum of all the bytes in
the file dynamic disk header without the checksum field.</p>
</blockquote>
<h3 id="parent-locator-entry"><a class="header" href="#parent-locator-entry">Parent locator entry</a></h3>
<p>The parent locator entry is 24 bytes in size and consists of:</p>
<div class="table-wrapper"><table><thead><th>Offset</th><th>Size</th><th>Value</th><th>Description</th></thead><tr><td>0</td><td>4</td><td></td><td>Locator platform code</td></tr>
<tr><td>4</td><td>4</td><td></td><td>Platform data space, which contains the number of 512-byte sectors needed to store the parent hard disk locator</td></tr>
<tr><td>8</td><td>4</td><td></td><td>Locator data size</td></tr>
<tr><td>12</td><td>4</td><td>0</td><td>Unknown (Reserved should contain 0-byte values)</td></tr>
<tr><td>16</td><td>8</td><td></td><td>Locator data offset, which contains the offset to the locator data. The offset is relative from the start of the file.</td></tr>
</table></div>
<h4 id="locator-platform-code"><a class="header" href="#locator-platform-code">Locator platform code</a></h4>
<div class="table-wrapper"><table><thead><th>Value</th><th>Identifier</th><th>Description</th></thead><tr><td>0</td><td></td><td>None</td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td>"Mac\x20"</td><td></td><td>Mac OS alias stored as a blob</td></tr>
<tr><td>"MacX"</td><td></td><td>File URL with UTF-8 encoding conforming to RFC 2396</td></tr>
<tr><td></td><td></td><td></td></tr>
<tr><td>"W2ku"</td><td></td><td>Absolute Windows path, which contains an UCS-2 big-endian string</td></tr>
<tr><td>"W2ru"</td><td></td><td>Windows path relative to the differential image, which contains an UCS-2 big-endian string</td></tr>
<tr><td>"Wi2k"</td><td></td><td>Unknown (Deprecated)</td></tr>
<tr><td>"Wi2r"</td><td></td><td>Unknown (Deprecated)</td></tr>
</table></div>
<h2 id="block-allocation-table"><a class="header" href="#block-allocation-table">Block allocation table</a></h2>
<p>The block allocation table is only used in dynamic and differential disk images.</p>
<p>The block allocation table consists of 32-bit entries. The entries represent
the sector number where the data block starts or unused when set to
0xffffffff (-1).</p>
<pre><code>if block allocation table entry == 0xffffffff (-1):
        block is sparse or stored in parent
else:
        file offset = ( block allocation table entry * 512 ) + sector bitmap size
</code></pre>
<p>Unused block in a dynamic disk are sparse and should be filled with zero byte
values. In a differential disk the block is stored in the parent disk image.</p>
<h2 id="data-blocks"><a class="header" href="#data-blocks">Data blocks</a></h2>
<p>Data blocks are only used in dynamic and differential disk images.</p>
<p>A data block consists of:</p>
<ul>
<li>sector bitmap</li>
<li>sector data</li>
</ul>
<pre><code>size of bitmap (in bytes) = block size / ( 512 * 8 )
</code></pre>
<p>The size of the bitmap is rounded up to the next multitude of the sector size.</p>
<h3 id="sector-bitmap"><a class="header" href="#sector-bitmap">Sector bitmap</a></h3>
<p>In dynamic disk images the sector bitmap indicates which sectors contain data
(bit set to 1) or are sparse (bit set to 0).</p>
<p>In differential disk images the sector bitmap indicates which sectors are stored
within the image (bit set to 1) or in the parent (bit set to 0).</p>
<p>The bitmap is padded to a 512-byte sector boundary.</p>
<p>The bitmap is stored on a per-byte basis with the MSB represents the first bit
in the bitmap.</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=23850">VHD Specifications</a>, by Microsoft</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="udif.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="vhdx.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="udif.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="vhdx.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
